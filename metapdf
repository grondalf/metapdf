#!/bin/bash

# --- Configuration: Colors & Formatting ---
BOLD="\033[1m"
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
CYAN="\033[1;36m"
RESET="\033[0m"

ICON_CHECK="${GREEN}✔${RESET}"
ICON_CROSS="${RED}✘${RESET}"
ICON_ARROW="${BLUE}➜${RESET}"
ICON_INFO="${CYAN}ℹ${RESET}"
ICON_GEAR="${YELLOW}⚙${RESET}"
ICON_Q="${YELLOW}?${RESET}"

# --- Function: Ask for Confirmation ---
ask_to_install() {
    local cmd_preview="$1"
    echo -e "${ICON_Q} ${BOLD}pdftk is missing.${RESET}"
    echo -e "   System detected: ${BOLD}${PRETTY_NAME:-$ID}${RESET}"
    echo -e "   Proposed command: ${YELLOW}$cmd_preview${RESET}"
    echo ""
    echo -e -n "${BOLD}Do you want to install it now? [y/N] ${RESET}"
    read response
    if [[ ! "$response" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
        echo -e "${ICON_CROSS} ${RED}Aborted by user.${RESET}"
        exit 1
    fi
}

# --- Function: Install pdftk ---
install_pdftk() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS_ID=$ID
        OS_LIKE=$ID_LIKE
    else
        echo -e "${ICON_CROSS} ${RED}Could not detect Linux distribution.${RESET}"
        exit 1
    fi

    # Simplified Install Logic for brevity (Full logic from previous version applies here)
    if [[ "$OS_LIKE" == *"debian"* || "$OS_LIKE" == *"ubuntu"* ]]; then
        ask_to_install "sudo apt install pdftk-java"
        sudo apt update && sudo apt install -y pdftk-java
    elif [[ "$OS_LIKE" == *"fedora"* ]]; then
        ask_to_install "sudo dnf install pdftk-java"
        sudo dnf install -y pdftk-java
    elif [[ "$OS_LIKE" == *"arch"* ]]; then
        ask_to_install "sudo pacman -S pdftk"
        sudo pacman -S --noconfirm pdftk
    else
        echo -e "${ICON_CROSS} ${RED}Unsupported distro. Install 'pdftk' manually.${RESET}"
        exit 1
    fi

    if ! command -v pdftk &> /dev/null; then
        echo -e "\n${ICON_CROSS} ${RED}Installation failed.${RESET}"
        exit 1
    fi
}

# --- Function: Interactive Bookmark Wizard ---
add_bookmarks_interactive() {
    echo -e "\n${BOLD}--- Interactive Bookmark Wizard ---${RESET}"
    echo -e "${ICON_INFO} Press ${YELLOW}[Enter]${RESET} without typing to stop adding bookmarks."
    
    while true; do
        echo ""
        # 1. Ask for Title
        echo -e -n "${CYAN}Bookmark Title${RESET} (or Enter to finish): "
        read bm_title
        
        # Break loop if empty
        if [[ -z "$bm_title" ]]; then
            break
        fi

        # 2. Ask for Page Number
        while true; do
            echo -e -n "${CYAN}Page Number${RESET}: "
            read bm_page
            # Simple check if it's a number
            if [[ "$bm_page" =~ ^[0-9]+$ ]]; then
                break
            else
                echo -e "${RED}Please enter a valid number.${RESET}"
            fi
        done

        # 3. Ask for Level
        echo -e -n "${CYAN}Level${RESET} (default: 1): "
        read bm_level
        # Default to 1 if empty
        if [[ -z "$bm_level" ]]; then
            bm_level="1"
        fi

        # 4. Append to Metadata File
        cat <<EOT >> "$META_FILE"
BookmarkBegin
BookmarkTitle: $bm_title
BookmarkLevel: $bm_level
BookmarkPageNumber: $bm_page
EOT
        echo -e "${ICON_CHECK} Added: ${BOLD}$bm_title${RESET} (Pg $bm_page, Lvl $bm_level)"
    done
    echo -e "${BOLD}--- Wizard Finished ---${RESET}\n"
}

# --- Main Script Execution ---

# 1. Check Prerequisites
if ! command -v pdftk &> /dev/null; then
    install_pdftk
fi

# 2. Check Arguments
if [ "$#" -ne 1 ]; then
    echo -e "${YELLOW}Usage:${RESET} $0 <input_pdf_file>"
    exit 1
fi

INPUT_PDF="$1"
BASENAME=$(basename "$INPUT_PDF" .pdf)
META_FILE="${BASENAME}_metadata.txt"
OUTPUT_PDF="${BASENAME}_fixed.pdf"

# 3. Validate Input File
if [ ! -f "$INPUT_PDF" ]; then
    echo -e "${ICON_CROSS} ${RED}Error: File '$INPUT_PDF' not found.${RESET}"
    exit 1
fi

clear
echo -e "${BOLD}PDF Metadata Fixer Tool${RESET}"
echo -e "${BOLD}=======================${RESET}\n"

# 4. Data Dump
echo -e "${ICON_ARROW} ${BOLD}Step 1: Extracting Metadata...${RESET}"
pdftk "$INPUT_PDF" data_dump output "$META_FILE"
if [ $? -ne 0 ]; then
    echo -e "   ${ICON_CROSS} ${RED}Failed. Is the PDF password protected?${RESET}"
    exit 1
fi
echo -e "   ${ICON_CHECK} Metadata dumped.\n"

# 5. Auto-Cleanup & Wizard
echo -e "${ICON_ARROW} ${BOLD}Step 2: Cleanup & Bookmarks...${RESET}"

# A. ALWAYS remove bloat lines (PageMedia)
sed -i '/^PageMedia/d' "$META_FILE"
echo -e "   ${ICON_CHECK} Removed 'PageMedia' bloat lines."

# B. Check for existing bookmarks
HAS_BOOKMARKS=false
if grep -q "BookmarkBegin" "$META_FILE"; then
    HAS_BOOKMARKS=true
    echo -e "   ${ICON_INFO} ${CYAN}Existing bookmarks detected.${RESET}"
fi

# C. Ask to run Wizard
echo ""
if [ "$HAS_BOOKMARKS" = true ]; then
    echo -e -n "${ICON_Q} ${BOLD}Add MORE bookmarks interactively? [y/N] ${RESET}"
else
    echo -e -n "${ICON_Q} ${BOLD}No bookmarks found. Add some now? [Y/n] ${RESET}"
fi

read response
# Default to YES if no bookmarks, NO if bookmarks exist (unless user types otherwise)
if [ "$HAS_BOOKMARKS" = false ]; then
    # If no bookmarks, default is Yes
    if [[ "$response" =~ ^([nN][oO]|[nN])+$ ]]; then
        RUN_WIZARD=false
    else
        RUN_WIZARD=true
    fi
else
    # If bookmarks exist, default is No
    if [[ "$response" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
        RUN_WIZARD=true
    else
        RUN_WIZARD=false
    fi
fi

if [ "$RUN_WIZARD" = true ]; then
    add_bookmarks_interactive
elif [ "$HAS_BOOKMARKS" = false ]; then
    # If no bookmarks and user refused wizard, add the template as fallback
    cat <<EOT >> "$META_FILE"
# BookmarkBegin
# BookmarkTitle: Example Chapter
# BookmarkLevel: 1
# BookmarkPageNumber: 1
EOT
    echo -e "   ${ICON_INFO} Added blank template instead."
fi

# 6. User Editing
echo -e "${ICON_ARROW} ${BOLD}Step 3: Review / Edit Metadata${RESET}"
echo -e "   ${ICON_INFO} ${YELLOW}Opening editor for final verification...${RESET}"
echo -e -n "${BOLD}Press [ENTER] to open editor...${RESET}"
read

EDITOR_CMD="${VISUAL:-${EDITOR:-nano}}"
$EDITOR_CMD "$META_FILE"
echo -e "\n   ${ICON_CHECK} Editor closed.\n"

# 7. Update PDF
echo -e "${ICON_ARROW} ${BOLD}Step 4: Creating New PDF...${RESET}"
pdftk "$INPUT_PDF" update_info "$META_FILE" output "$OUTPUT_PDF"

if [ $? -eq 0 ]; then
    echo -e "\n${GREEN}${BOLD}SUCCESS!${RESET} New file: ${GREEN}$OUTPUT_PDF${RESET}\n"
    
    # Cleanup Prompt
    echo -e -n "${YELLOW}Delete temp file ($META_FILE)? [y/N] ${RESET}"
    read response
    if [[ "$response" =~ ^([yY][eE][sS]|[yY])+$ ]]; then
        rm "$META_FILE"
        echo -e "   ${ICON_CHECK} Deleted."
    else
        echo -e "   ${ICON_INFO} Kept."
    fi
else
    echo -e "${ICON_CROSS} ${RED}Error: Failed to create PDF.${RESET}"
    exit 1
fi
